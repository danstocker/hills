var app={config:{},service:{},state:{},model:{},widgets:{},utils:{}};!function(){"use strict";troop.Properties.addProperties.call(String.prototype,{toCompressed:function(){return LZString.compressToBase64(this)},toDecompressed:function(){return LZString.decompressFromBase64(this)},toUriComponentEncoded:function(){return encodeURIComponent(this)},toUriComponentDecoded:function(){return decodeURIComponent(this)}},!1,!1,!1)}(),troop.amendPostponed(bookworm,"config",function(){"use strict";bookworm.config.items={document:{document:{board:{ref:"reference",width:"number",height:"number",tiles:"ordered-collection"},pattern:{ref:"reference",symbol:"text"},patterns:{ref:"reference",patterns:"ordered-collection"},tile:{ref:"reference",pattern:"reference",elevation:"number",orientation:"number"},preferences:{ref:"reference",pattern:"reference"}}}}}),troop.amendPostponed(bookworm,"entities",function(){"use strict";bookworm.entities.items={document:{preferences:{main:{pattern:"pattern/2"}},pattern:{1:{ref:"pattern/1",symbol:"O",top:0,left:0,desc:"Asphalt"},2:{ref:"pattern/2",symbol:"I",top:1,left:0,desc:"Straight road"},3:{ref:"pattern/3",symbol:"T",top:2,left:0,desc:"T junction"},4:{ref:"pattern/4",symbol:"^",top:3,left:0,desc:"Lot entrance"},5:{ref:"pattern/5",symbol:"#",top:4,left:0,desc:"Crossing"},6:{ref:"pattern/6",symbol:"_",top:5,left:0,desc:"Lot edge"},7:{ref:"pattern/7",symbol:"L",top:6,left:0,desc:"Lot corner"},8:{ref:"pattern/8",symbol:"U",top:7,left:0,desc:"Dead end"},9:{ref:"pattern/9",symbol:"C",top:8,left:0,desc:"Turn"},10:{ref:"pattern/10",symbol:"V",top:9,left:0,desc:"Ramp"},11:{ref:"pattern/11",symbol:"A",top:10,left:0,desc:"Bridge ramp"},12:{ref:"pattern/12",symbol:"-",top:11,left:0,desc:"Grass"},13:{ref:"pattern/13",symbol:"=",top:12,left:0,desc:"High grass"},14:{ref:"pattern/14",symbol:"/",top:13,left:0,desc:"Hill side"},15:{ref:"pattern/15",symbol:"Y",top:14,left:0,desc:"Hill corner"},16:{ref:"pattern/16",symbol:"~",top:0,left:1,desc:"Water"},17:{ref:"pattern/17",symbol:"i",top:1,left:1,desc:"Bridge"},18:{ref:"pattern/18",symbol:"`",top:2,left:1,desc:"Sand tip"},19:{ref:"pattern/19",symbol:"]",top:3,left:1,desc:"Sand edge"},20:{ref:"pattern/20",symbol:"j",top:4,left:1,desc:"Sand corner"},21:{ref:"pattern/21",symbol:")",top:5,left:1,desc:"Sand turn"},22:{ref:"pattern/22",symbol:"|",top:6,left:1,desc:"Sand waterway"},23:{ref:"pattern/23",symbol:"'",top:7,left:1,desc:"Grass tip"},24:{ref:"pattern/24",symbol:"[",top:8,left:1,desc:"Grass edge"},25:{ref:"pattern/25",symbol:"l",top:9,left:1,desc:"Grass corner"},26:{ref:"pattern/26",symbol:"(",top:10,left:1,desc:"Grass turn"},27:{ref:"pattern/27",symbol:"1",top:11,left:1,desc:"Grass waterway"},28:{ref:"pattern/28",symbol:".",top:12,left:1,desc:"Dirt"},29:{ref:"pattern/29",symbol:":",top:13,left:1,desc:"High dirt"},30:{ref:"pattern/30",symbol:",",top:14,left:1,desc:"Sand"}},patterns:{all:{ref:"patterns/all",patterns:{"pattern/1":0,"pattern/2":1,"pattern/3":2,"pattern/4":3,"pattern/5":4,"pattern/6":5,"pattern/7":6,"pattern/8":7,"pattern/9":8,"pattern/10":9,"pattern/11":10,"pattern/12":11,"pattern/13":12,"pattern/14":13,"pattern/15":14,"pattern/16":15,"pattern/17":16,"pattern/18":17,"pattern/19":18,"pattern/20":19,"pattern/21":20,"pattern/22":21,"pattern/23":22,"pattern/24":23,"pattern/25":24,"pattern/26":25,"pattern/27":26,"pattern/28":27,"pattern/29":28,"pattern/30":29}}}}}}),troop.postpone(app.state,"BoardRouter",function(){"use strict";var a=troop.Base,b=a.extend();app.state.BoardRouter=b.addConstants({DEFAULT_ROUTE:"LQPg%2BqHpPXUNo%2BTUvczase33BOR%2BxhJ5Zlp1FNVtD9TdLjrzbnH37vXfPfkMEiBY4eNETpU2ZPkyFcxSuVqlG1ZvVbdO%2FdsN6jB42dMWTV89cs37dx7ecOXT1x%2Fde3Pz7%2B9%2BgQHB%2FqFBYSHhUYRAAA%3D%3D"}).addMethods({onTileItemChange:function(a){a.originalPath.clone().trimLeft().toDocumentKey().toDocument().toString().toCompressed().toUriComponentEncoded().toRoute().setNextOriginalEvent(a).navigateTo().clearNextOriginalEvent()},onRouteChange:function(a){var b=a.beforeRoute,c=a.afterRoute,d=[].toRoute();c&&(c.equals(d)?this.DEFAULT_ROUTE.toRoute().navigateTo():(!b||b.equals(d))&&c.toString().toUriComponentDecoded().toBoardDocumentFromCompressed())}})}),troop.amendPostponed(bookworm,"entities",function(a,b,c){"use strict";bookworm.entities.delegateSubscriptionTo(flock.ChangeEvent.EVENT_CACHE_CHANGE,"document>board".toPath(),"document>board>|>tiles>|>|".toQuery(),function(a){c.BoardRouter.onTileItemChange(a)})},app.state),troop.amendPostponed(milkman,"Route",function(a,b,c){"use strict";[].toRoute().subscribeTo(milkman.Router.EVENT_ROUTE_CHANGE,function(a){c.BoardRouter.onRouteChange(a)})},app.state),troop.postpone(app.model,"PatternDocument",function(){"use strict";var a=bookworm.Document,b=a.extend();app.model.PatternDocument=b.setInstanceMapper(function(a){return a.toString()}).addConstants({SPRITE_HORIZONTAL_SPACING:150,SPRITE_VERTICAL_SPACING:100}).addMethods({getSymbol:function(){return this.getField("symbol").getValue()},getBackgroundTop:function(){return-this.getField("top").getValue()*this.SPRITE_VERTICAL_SPACING},getBackgroundLeft:function(){return-this.getField("left").getValue()*this.SPRITE_HORIZONTAL_SPACING*4},getHorizontalOffset:function(a){return-a*this.SPRITE_HORIZONTAL_SPACING}})}),troop.amendPostponed(bookworm,"Document",function(a,b,c){"use strict";bookworm.Document.addSurrogate(c,"PatternDocument",function(a){return"pattern"===a.documentType})},app.model),troop.postpone(app.model,"PatternsDocument",function(){"use strict";var a=bookworm.Document,b=a.extend();app.model.PatternsDocument=b.setInstanceMapper(function(a){return a.toString()}).addPrivateMethods({_addBySymbolLookup:function(){var a=this.getField("patterns").getItemsAsCollection().mapValues(function(a,b){return b.toDocument().getSymbol()}).toStringDictionary().reverse().items;bookworm.index.setNode("pattern>by-symbol".toPath(),a)},_addByReferenceLookup:function(){var a=this.getField("patterns").getItemsAsCollection().mapValues(function(a,b){return b.toDocument().getSymbol()}).items;bookworm.index.setNode("pattern>by-reference".toPath(),a)}}).addMethods({init:function(b){a.init.call(this,b),this._addBySymbolLookup(),this._addByReferenceLookup()},getPatternsAsCollection:function(){return this.getField("patterns").getItemsAsCollection().getKeysAsHash().toCollection().callOnEachItem("toDocumentKey")},getPatternKeyBySymbol:function(a){var b=bookworm.index.getNode(["pattern","by-symbol",a].toPath());return b?b.toDocumentKey():void 0}})}),troop.amendPostponed(bookworm,"Document",function(a,b,c){"use strict";bookworm.Document.addSurrogate(c,"PatternsDocument",function(a){return"patterns"===a.documentType})},app.model),troop.postpone(app.model,"BoardDocument",function(a){"use strict";var b=bookworm.Document,c=b.extend();app.model.BoardDocument=c.setInstanceMapper(function(a){return a.toString()}).addPrivateMethods({_setTiles:function(a){this.getField("tiles").setValue(a)}}).addMethods({setWidth:function(a){return this.getField("width").setValue(a),this},getWidth:function(){return this.getField("width").getValue()},setHeight:function(a){return this.getField("height").setValue(a),this},getHeight:function(){return this.getField("height").getValue()},getTileKeysAsCollection:function(){var a=this.entityKey.getFieldKey("tiles");return this.getField("tiles").getItemsAsCollection().mapValues(function(b,c){return a.getItemKey(c)})},getTilesNodeFromString:function(b){var c,d,e=b.match(/.{1,3}/g),f=a.TileItem,g=[];for(c=0;c<e.length;c++)d=e[c],g.push(f.getTileNodeFromString(d));return g},fromString:function(a){"patterns/all".toDocument();var b=Math.sqrt(a.length/12);return this.setWidth(b).setHeight(4*b),this._setTiles(this.getTilesNodeFromString(a)),this},fromCompressedString:function(a){return this.fromString(a.toDecompressed())},exportMap:function(){return'"'+this.toString().match(new RegExp(".{1,"+3*this.getWidth()+"}","g")).join('"+\n"')+'"'},toString:function(){var b,c,d,e=this.getField("tiles"),f=e.getValue(),g=Object.keys(f),h=a.TileItem,i=bookworm.index.items.pattern["by-reference"],j=[];for(b=0;b<g.length;b++)c=g[b],d=f[c],j.push(h.getStringFromTileNode(i[d.pattern],d.orientation,d.elevation));return j.join("")}})}),troop.amendPostponed(bookworm,"Document",function(a,b,c){"use strict";bookworm.Document.addSurrogate(c,"BoardDocument",function(a){return"board"===a.documentType})},app.model),function(){"use strict";troop.Properties.addProperties.call(String.prototype,{toBoardDocument:function(a){return["board",a||"main"].toDocument().fromString(this.valueOf())},toBoardDocumentFromCompressed:function(a){return["board",a||"main"].toDocument().fromCompressedString(this.valueOf())}},!1,!1,!1)}(),troop.postpone(app.model,"TileItem",function(){"use strict";var a=bookworm.Item,b=a.extend(),c=sntls.StringDictionary.create({0:">",90:"^",180:"<",270:"~"}),d=sntls.StringDictionary.create({0:"_",1:"-",2:"^"});app.model.TileItem=b.addConstants({orientationToSymbol:c,symbolToOrientation:c.reverse(),elevationToSymbol:d,symbolToElevation:d.reverse()}).addMethods({setPatternKey:function(a){return this.setAttribute("pattern",a.toString()),this},getPatternKey:function(){var a=this.getAttribute("pattern");return a?a.toDocumentKey():void 0},setElevation:function(a){return this.setAttribute("elevation",a),this},raiseElevation:function(){var a=this.getElevation();return 2>a&&this.setElevation(a+1),this},lowerElevation:function(){var a=this.getElevation();return a>0&&this.setElevation(a-1),this},getElevation:function(){return this.getAttribute("elevation")||0},setOrientation:function(a){return this.setAttribute("orientation",a),this},getOrientation:function(){return this.getAttribute("orientation")||0},getOrientationShift:function(){return this.getOrientation()/90},rotateClockwise:function(){var a=this.getOrientation();return this.setOrientation((a+90)%360),this},rotateCounterClockwise:function(){var a=this.getOrientation();return this.setOrientation((a+270)%360),this},getTileNodeFromString:function(a){var b=bookworm.index.items.pattern["by-symbol"][a[0]],c=parseInt(this.symbolToOrientation.items[a[1]],10),d=parseInt(this.symbolToElevation.items[a[2]],10);return{pattern:b,orientation:c,elevation:d}},getStringFromTileNode:function(a,b,c){return[a,this.orientationToSymbol.items[b],this.elevationToSymbol.items[c]].join("")},toString:function(){return[this.getPatternKey().toDocument().getSymbol(),this.orientationToSymbol.getItem(this.getOrientation()),this.elevationToSymbol.getItem(this.getElevation())].join("")}})}),troop.amendPostponed(bookworm,"Item",function(a,b,c){"use strict";bookworm.Item.addSurrogate(c,"TileItem",function(a){return"tiles"===a.fieldName&&"board"===a.documentKey.documentType})},app.model),troop.postpone(app.model,"PreferencesDocument",function(){"use strict";var a=bookworm.Document,b=a.extend();app.model.PreferencesDocument=b.addMethods({getPatternKey:function(){var a=this.getField("pattern").getValue();return a?a.toDocumentKey():void 0}})}),troop.amendPostponed(bookworm,"Document",function(a,b,c){"use strict";bookworm.Document.addSurrogate(c,"PreferencesDocument",function(a){return"preferences"===a.documentType})},app.model),troop.postpone(app.widgets,"Pattern",function(a,b){"use strict";var c=shoeshine.Widget,d=c.extend(b).addTrait(candystore.EntityWidget);app.widgets.Pattern=d.addConstants({PATTERN_TOP_OFFSET:-20,PATTERN_LEFT_OFFSET:0}).addMethods({init:function(a){c.init.call(this),candystore.EntityWidget.init.call(this,a),this.setShift(0)},setShift:function(a){var b=this.entityKey.toDocument();return this.setInlineStyle("background-position",[this.PATTERN_LEFT_OFFSET+b.getBackgroundLeft()+b.getHorizontalOffset(a)+"px",this.PATTERN_TOP_OFFSET+b.getBackgroundTop()+"px"].join(" ")),this}})}),troop.postpone(app.widgets,"Tile",function(a,b){"use strict";var c=shoeshine.Widget,d=c.extend(b).addTrait(shoeshine.JqueryWidget).addTrait(bookworm.EntityBound).addTrait(candystore.EntityWidget).addTrait(candystore.Highlightable,"Highlightable");app.widgets.Tile=d.setInstanceMapper(function(a){return a.toString()}).addConstants({EVENT_TILE_CLICK:"tile-click",TILE_WIDTH:100,TILE_HEIGHT:50,TILE_VISIBLE_HEIGHT:150}).addPrivateMethods({_updateElevation:function(){var a=this.entityKey.toItem();this.htmlAttributes.cssClasses.filterByPrefix("elevation-").passEachItemTo(this.removeCssClass,this),this.addCssClass("elevation-"+a.getElevation())},_updatePattern:function(){var b=this.entityKey.toItem();a.Pattern.create(b.getPatternKey()).setChildName("pattern").setShift(b.getOrientationShift()).addToParent(this)}}).addMethods({init:function(a){dessert.isItemKey(a,"Invalid tile key"),c.init.call(this),bookworm.EntityBound.init.call(this),candystore.EntityWidget.init.call(this,a),candystore.Highlightable.init.call(this),this._updateElevation(),this._updatePattern()},afterAdd:function(){c.afterAdd.call(this),this._updateElevation(),this._updatePattern(),this.bindToEntityChange(this.entityKey,"onTileChange")},afterRemove:function(){c.afterAdd.call(this),this.unbindAll()},contentMarkup:function(){return[this.getChild("pattern"),'<div class="mouse-area"></div>'].join("")},getTopPosition:function(){return this.htmlAttributes.inlineStyles.getItem("top")},getLeftPosition:function(){return this.htmlAttributes.inlineStyles.getItem("left")},onTileChange:function(){this._updatePattern(),this._updateElevation()},onClick:function(a){var b=this.entityKey.toItem();a&&a.ctrlKey||a.metaKey?a.shiftKey?b.rotateCounterClockwise():b.rotateClockwise():a&&a.altKey?a.shiftKey?b.lowerElevation():b.raiseElevation():b.setPatternKey("preferences/main".toDocument().getPatternKey())},onMouseEnter:function(){this.highlightOn("hover")},onMouseLeave:function(){this.highlightOff("hover")}}),d.on("click","","onClick").on("mouseenter",".mouse-area","onMouseEnter").on("mouseleave",".mouse-area","onMouseLeave")}),troop.postpone(app.widgets,"Board",function(a,b){"use strict";var c=shoeshine.Widget,d=c.extend(b).addTrait(bookworm.EntityBound).addTrait(candystore.EntityWidget);app.widgets.Board=d.setInstanceMapper(function(a){return a.toString()}).addPrivateMethods({_updateTiles:function(){var b=this,c=this.entityKey.toDocument(),d=c.getWidth(),e=c.getHeight(),f=a.Tile.TILE_WIDTH,g=a.Tile.TILE_HEIGHT,h=shoeshine.Progenitor;this.setInlineStyle("left",-f/2+"px").setInlineStyle("top",-g/2+"px").setInlineStyle("width",f*d+"px").setInlineStyle("height",g/2*(e-.5)+"px"),c.getTileKeysAsCollection().createWithEachItem(a.Tile).forEachItem(function(a,c){c=parseInt(c,10);var e=c%d,i=Math.floor(c/d),j=i%2,k=f/2*(j?1:0);a.setChildName("tile-"+candystore.StringUtils.padLeft(c,5)).setInlineStyle("z-index",Math.floor(c/d)).setInlineStyle("left",e*f+k+"px").setInlineStyle("top",i*g/2+"px"),h.addToParent.call(a,b)}),this.reRender()}}).addMethods({init:function(a){c.init.call(this),bookworm.EntityBound.init.call(this),candystore.EntityWidget.init.call(this,a)},afterAdd:function(){c.afterAdd.call(this),this._updateTiles(),this.bindToEntityNodeChange(this.entityKey,"onDocumentReplace").bindToEntityNodeChange(this.entityKey.getFieldKey("tiles"),"onTilesReplace")},afterRemove:function(){c.afterRemove.call(this),this.unbindAll()},contentMarkup:function(){return this.children.toString()},onDocumentReplace:function(){this._updateTiles()},onTilesReplace:function(){this._updateTiles()}})}),troop.postpone(app.widgets,"PatternOption",function(a,b){"use strict";var c=shoeshine.Widget,d=c.extend(b).addTraitAndExtend(candystore.Highlightable,"Highlightable").addTraitAndExtend(candystore.Option,"Option");app.widgets.PatternOption=d.addMethods({init:function(b){c.init.call(this,b),candystore.Highlightable.init.call(this),candystore.Option.init.call(this),a.Pattern.create(b).setChildName("pattern").addToParent(this)},afterRender:function(){c.afterRender.call(this),candystore.Option.afterRender.call(this)},contentMarkup:function(){return this.children.toString()}})}),troop.postpone(app.widgets,"PatternList",function(a,b){"use strict";var c=candystore.DataList,d=c.extend(b).addTraitAndExtend(candystore.OptionList,"OptionList");app.widgets.PatternList=d.addMethods({init:function(a){c.init.call(this,a),candystore.OptionList.init.call(this)},afterAdd:function(){c.afterAdd.call(this),candystore.OptionList.afterAdd.call(this)},afterRemove:function(){c.afterRemove.call(this),candystore.OptionList.afterRemove.call(this)},afterRender:function(){c.afterRender.call(this)},contentMarkup:function(){return this.children.toString()},createItemWidget:function(b){var c=b.referenceKey;return a.PatternOption.create(c).setOptionValue(c.toString())}})}),troop.amendPostponed(candystore,"DataList",function(a,b,c){"use strict";candystore.DataList.addSurrogate(c,"PatternList",function(a){return"patterns"===a.fieldName&&"patterns"===a.documentKey.documentType})},app.widgets),troop.postpone(app.widgets,"PatternDropdownButton",function(a,b){"use strict";var c=candystore.DataDropdownButton,d=c.extend(b);app.widgets.PatternDropdownButton=d.addPrivateMethods({_updatePattern:function(){this.createLabelWidget().setChildName("button-label").addToParent(this)}}).addMethods({createLabelWidget:function(){var b=this.entityKey.toField().getValue();return b?a.Pattern.create(b.toDocumentKey()):c.createLabelWidget.apply(this,arguments)},createDropdownWidget:function(){return c.createDropdownWidget.apply(this,arguments).setPositionOption("my","left top").setPositionOption("at","right top")},onSelectedChange:function(){c.onSelectedChange.apply(this,arguments),this._updatePattern()}})}),troop.postpone(app.widgets,"MapPage",function(a,b){"use strict";var c=candystore.Page,d=c.extend(b);app.widgets.MapPage=d.setInstanceMapper(function(){return"singleton"}).addMethods({init:function(){c.init.call(this),a.Board.create("board/main".toDocumentKey()).setChildName("board").addToParent(this),a.PatternDropdownButton.create("preferences/main/pattern".toFieldKey(),"patterns/all/patterns".toFieldKey()).setChildName("palette-button").addToParent(this)},contentMarkup:function(){return this.children.toString()}})});